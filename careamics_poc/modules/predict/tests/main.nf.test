nextflow_process {

    name "Test Process PREDICT_CLI"
    script "../main.nf"
    process "PREDICT_CLI"
    tag "modules"
    tag "modules_local"
    tag "careamics"
    tag "prediction"

    test("denoise test data") {

        when {
            params {
               module_args= "--tile_size '256 256' --tile_overlap '48 48' --write_type tiff --data_type tiff --axes YX --batch_size 32"
            }
            process {
                config "/home/tatiana/hackathon_leuven_2024/careamics_poc/modules/predict/tests/nextflow.config"
                """
                input[0] = tuple(
                    file('/home/tatiana/test_careamics/n2v_test_sem/test.tif'),                    
                    file('/home/tatiana/results_careamics/train_n2v/checkpoints/last.ckpt'),
                    'tiff'
                )
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.predictions.size() >= 1 },
                { assert path(process.out.predictions[0]).exists() },
                {assert snapshot(process.out.predictions[0]).match("predictions")}
            )
        }
    }

    test("stub") {

        options "-stub"

        when {
            params {
               module_args= "--tile_size '256 256' --tile_overlap '48 48' --write_type tiff --data_type tiff  --batch_size 32 --axes YX"
            }
            process {
                config "/home/tatiana/hackathon_leuven_2024/careamics_poc/modules/predict/tests/nextflow.config"
                """
                input[0] = tuple(
                    file('/home/tatiana/test_careamics/n2v_test_sem/test.tif'),
                    file('/home/tatiana/results_careamics/train_n2v/checkpoints/last.ckpt'),
                    'tiff'
                    )
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match()}
            )
        }
    }
}
